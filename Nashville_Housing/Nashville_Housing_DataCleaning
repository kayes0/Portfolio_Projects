-- Data cleaning 
-- Raw data 
SELECT *
FROM PortfolioProject.dbo.NashvilleHousing

-- Standardise data type for SaleDate
ALTER TABLE PortfolioProject.dbo.NashvilleHousing
ALTER COLUMN SaleDate date;

-- Identify missing data in PropertyAddress
SELECT SUM(
CASE WHEN PropertyAddress IS NULL THEN 1 ELSE 0 END) AS MissingAddress
FROM PortfolioProject.dbo.NashvilleHousing;

-- Populate missing PropertyAddress values using ParcelID
SELECT a.ParcelID, a.PropertyAddress, b.ParcelID, b.PropertyAddress,
ISNULL(a.PropertyAddress, b.PropertyAddress) AS UpdatedAddress
FROM PortfolioProject.dbo.NashvilleHousing a
JOIN PortfolioProject.dbo.NashvilleHousing b
ON a.ParcelID= b.ParcelID
AND a.[UniqueID ]<>b.[UniqueID ]
WHERE a.PropertyAddress IS NULL;

UPDATE a
SET a.PropertyAddress = ISNULL(a.PropertyAddress, b.PropertyAddress)
FROM PortfolioProject.dbo.NashvilleHousing a
JOIN PortfolioProject.dbo.NashvilleHousing b
ON a.ParcelID= b.ParcelID
AND a.[UniqueID ]<>b.[UniqueID ]
WHERE a.PropertyAddress IS NULL;

-- Split PropertyAddress into Address and City using SUBSTRING
SELECT SUBSTRING(PropertyAddress,1, CHARINDEX(',',PropertyAddress)-1) AS PropertySplitAddress,
SUBSTRING(PropertyAddress,CHARINDEX(',',PropertyAddress)+1, LEN(PropertyAddress)) AS PropertySplitCity
FROM PortfolioProject.dbo.NashvilleHousing;

ALTER TABLE PortfolioProject.dbo.NashvilleHousing
ADD PropertySplitAddress NVARCHAR(255),
PropertySplitCity NVARCHAR(255);

UPDATE PortfolioProject.dbo.NashvilleHousing
SET PropertySplitAddress = SUBSTRING(PropertyAddress,1, CHARINDEX(',',PropertyAddress)-1),
PropertySplitCity = SUBSTRING(PropertyAddress,CHARINDEX(',',PropertyAddress)+1, LEN(PropertyAddress))

-- Split OwnerAddress into Address, City and State using PARSENAME
SELECT PARSENAME(REPLACE(OwnerAddress, ',', '.'),3),
PARSENAME(REPLACE(OwnerAddress, ',', '.'),2),
PARSENAME(REPLACE(OwnerAddress, ',', '.'),1)
FROM PortfolioProject.dbo.NashvilleHousing;

ALTER TABLE PortfolioProject.dbo.NashvilleHousing
ADD OwnerSplitAddress NVARCHAR(255),
	OwnerSplitCity NVARCHAR(255),
	OwnerSplitState NVARCHAR(255);

UPDATE PortfolioProject.dbo.NashvilleHousing
SET OwnerSplitAddress= PARSENAME(REPLACE(OwnerAddress, ',', '.'),3),
	OwnerSplitCity= PARSENAME(REPLACE(OwnerAddress, ',', '.'),2),
	OwnerSplitState= PARSENAME(REPLACE(OwnerAddress, ',', '.'),1);

-- Normalise SoldAsVacant field values
SELECT DISTINCT(SoldAsVacant), COUNT(*) AS Count
FROM PortfolioProject.dbo.NashvilleHousing
GROUP BY SoldAsVacant
ORDER BY Count DESC

UPDATE PortfolioProject.dbo.NashvilleHousing
SET SoldAsVacant= CASE WHEN SoldAsVacant = 'Y' THEN 'Yes'
						WHEN SoldAsVacant= 'N' THEN 'No'
						ELSE SoldAsVacant 
						END;

-- Remove duplicate records
WITH row_num_CTE AS (
SELECT *, 
		ROW_NUMBER() OVER(
		PARTITION BY ParcelID,
		PropertyAddress,
		SalePrice, SaleDate,
		LegalReference 
		ORDER BY UniqueID) AS row_num
		FROM PortfolioProject.dbo.NashvilleHousing)

DELETE
FROM row_num_CTE
WHERE row_num> 1;

-- Delete unused column
ALTER TABLE PortfolioProject.dbo.NashvilleHousing
DROP COLUMN OwnerAddress, PropertyAddress, TaxDistrict;
